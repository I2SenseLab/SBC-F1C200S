name: Build flash.bin

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: [self-hosted, Linux, X64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Initialize submodules
      run: git submodule update --init --recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc-arm-linux-gnueabi u-boot-tools python3-pip python3-setuptools python3-wheel unzip

    # Install pip dependencies, not needed any more
    # - name: Install pip dependencies
    #   run: |
    #     python3 -m pip install --upgrade pip
    #     python3 -m pip install pylibfdt


    - name: Configure buildroot
      working-directory: Software/buildroot
      run: BR2_EXTERNAL=../simple_sbc make f1c200s_simple_sbc_defconfig

    # 1) Build the kernel only (so we have vmlinux)
    - name: Build kernel only
      working-directory: Software/buildroot
      run: |
        make linux-extract
        make linux-patch
        make linux-configure
        make linux-build

    - name: Analyze kernel size
      working-directory: Software/buildroot
      run: |
        cd output/build/linux-*
        scripts/bloat-o-meter vmlinux > /tmp/bloat_report.txt
        cat /tmp/bloat_report.txt

    - name: Upload bloat report
      uses: actions/upload-artifact@v4
      with:
        name: bloat-report
        path: /tmp/bloat_report.txt

    # 3) Finally do the full build (including final packaging into flash.bin)
    - name: Build flash.bin
      working-directory: Software/buildroot
      run: |
        make clean
        make -j"$(nproc)"

    - name: Upload flash.bin
      uses: actions/upload-artifact@v4
      with:
        name: flash.bin
        path: Software/buildroot/output/images/flash.bin